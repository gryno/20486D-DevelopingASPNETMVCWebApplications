# Module 3: Configuring Middleware and Services in ASP.NET Core

Wherever a path to a file starts with *[Repository Root]*, replace it with the absolute path to the folder in which the 20486 repository resides. For example, if you cloned or extracted the 20486 repository to **C:\Users\John Doe\Downloads\20486**, change the path: **[Repository Root]\AllFiles\20486D\Mod01** to **C:\Users\John Doe\Downloads\20486\AllFiles\20486D\Mod01**.

# Lab: Configuring Middleware and Services in ASP.NET Core

#### Scenario
The Adventure Works company wants to develop a website about ball games. For this, the company needs to perform a survey to determine the popularity of different ball games. As their employee, you are required to create a survey site.

#### Objectives

After completing this lab, you will be able to:

-	Use Microsoft ASP.NET Core static files such as HTML, CSS, and image files.
-	Create and use a custom middleware and use its context information.
-	Create and use services with ASP.NET Core built-in dependency injection.
-	Inject a service to an ASP.NET Core MVC controller.

#### Lab Setup

Estimated Time: **75 minutes**

### Preparation Steps

Ensure that you have cloned the **20486D** directory from GitHub. It contains the code segments for the labs and demos in this course. (**https://github.com/MicrosoftLearning/20486D-DevelopingASPNETMVCWebApplications/tree/master/Allfiles**).

### Exercise 1: Working with Static Files

#### Scenario

To create the poll, the application needs a styled HTML page. The HTML page must post the poll results to the server. To transfer the results to the server you will use an HTML form.

The main tasks for this exercise are the following: 

1.	Create a new project by using the ASP.NET Core Empty project template

2.	Run the application

3.	Add an HTML file to the **wwwroot** folder

4.	Run the application - the content of the HTML file is not displayed

5.	Enable working with static files

6.	Run the application - the content of the HTML file is displayed

7.	Add an HTML file outside of the **wwwroot** folder

8.	Run the application - the content of the HTML file outside the **wwwroot** folder is not displayed

####	Task 1: Create a new project by using the ASP.NET Core Empty project template

1. Open Microsoft Visual Studio 2017 and create a new ASP.NET Core web application with following information:

    - Name: **PollBall**
    - Location: **[Repository Root]\Allfiles\Mod03\Labfiles\01_PollBall_begin**
    - Create directory for solution: **True**
    - Project template: **Empty**
    - Enable Docker Support: **False**
    - Configure for HTTPS: **False**

2. Start the application without debugging.

3. In Microsoft Edge, in the address bar, note the port number that appears at the end of the URL **http://localhost:[port]**. You will use the port number during this lab.

4. Close Microsoft Edge.  

5. In the **Startup** class, delete all the comments.

6. Delete the **Configure** method with its content.

7. Add a method with the following information:
    - Scope: **public**
    - Return Type: **void**
    - Name: **Configure**
    - Parameter:
        - Type: **IApplicationBuilder**
        - Name: **app**

8. In the **Configure** method, call the **Run** method of the *app* parameter. To the **Run** method, pass an async lambda expression with the following information:
    - Expression: **async (context) => { }**

9. In the async **lambda expression** code block, call the **context.Response.WriteAsync** method by using the **await** operator. To the **WriteAsync** method, pass *This text was generated by the app.Run middleware.* as a parameter. 

####	Task 2: Run the application

1. Save all the changes.

2. Start the application without debugging.
    >**Note**: The browser displays the following text **This text was generated by the app.Run middleware.**

3. Close Microsoft Edge.

####	Task 3: Add an HTML file to the wwwroot folder

1. Create a new folder with the following information:
    - Folder: **css**
    - Parent folder: **wwwroot**

2. To the **PollBall** project, copy the **style.css** file with the following information:
    - Source location: **[Repository Root]\Allfiles\Mod03\Labfiles\01_PollBall_begin**
    - Target location:  **[Repository Root]\Allfiles\Mod03\Labfiles\01_PollBall_begin\PollBall\PollBall\wwwroot\css**

3. To the **PollBall** project, copy the **images** folder with the following information:
    - Source location: **[Repository Root]\Allfiles\Mod03\Labfiles\01_PollBall_begin**
    - Target location: **[Repository Root]\Allfiles\Mod03\Labfiles\01_PollBall_begin\PollBall\PollBall\wwwroot** 

4. Create a new HTML page with the following information:
    - Folder: **wwwroot**
    - File name: **poll-questions**

5. In the **BODY** element, add a **P** element.

6. In the **P** element, add an **H1** element with the following information: 
    - Content: **Favorite Ball Game Poll**

7. After the **H1** element, add the following content: **Please select your favorite ball game and then press Submit Poll.**

8. After the **P** element, add a **FORM** element with the following information: 
    - Class: **submit-form**

9. In the **FORM** element, add a **DIV** element with the following information: 
    - Class: **main-div**

10. After the **DIV** element, add another **DIV** element with the following information: 
    - Class: **submit-batch**

11. In the **DIV** element with the **submit-batch** class, add an **input** element with the following information: 
    - Type: **submit**
    - Value: **Submit Poll**

12. Copy the content of the **html-text.txt** file with following information:
    - Source location: **[Repository Root]\Allfiles\Mod03\Labfiles\01_PollBall_begin**

13. In the **poll-questions.html** file, paste the copied content into the **DIV** element with the **main-div** class.

####	Task 4: Run the application – content of the HTML file is not displayed

1. Save all the changes.

2. Start the application without debugging.

3. Access the following relative path:
    - Path: **/poll-questions.html**
    >**Note**: The browser displays the following text **This text was generated by the app.Run middleware.**

4. Close Microsoft Edge.

####	Task 5: Enable working with static files

1. In the **Startup** class, in the **Configure** method code block, call the **UseStaticFiles** method of the *app* parameter.


####	Task 6: Run the application – content of the HTML file is displayed

1. Save all the changes.

2. Start the application without debugging.

3. Access the following relative path:
    - Path: **/poll-questions.html**
    >**Note**: The browser displays the **poll-questions.html** file content, but the HTML content is not designed by using a CSS file yet.

4. Close Microsoft Edge.

5. In the **poll-questions.html** file, in the **HEAD** element, add a **LINK** element with the following information:
    - Type: **text/css**
    - Rel: **stylesheet**
    - Href: **css/style.css**

6. Save all the changes.

7. Start the application without debugging.

8. Access the following relative path: 
    - Path: **/poll-questions.html**
    >**Note**: The browser displays the **poll-questions.html** file content that is designed by using the **style.css** file.

9. Close Microsoft Edge.


####	Task 7: Add an HTML file outside of the wwwroot folder

1. Copy the **test.html** file to the **PollBall** project with the following information:
    - Source location: **[Repository Root]\Allfiles\Mod03\Labfiles\01_PollBall_begin**
    - Target location:  **[Repository Root]\Allfiles\Mod03\Labfiles\01_PollBall_begin\PollBall\PollBall**

####	Task 8: Run the application – content of HTML outside the wwwroot folder not displayed

1. Start the application without debugging.

2. Access the following relative path:
    - Path: **/test.html**
    >**Note**: The browser displays the following text **This text was generated by the app.Run middleware.**

3. Close Microsoft Edge.


>**Result**: At the end of this exercise, you will be able to work with static files inside an ASP.NET Core project.

### Exercise 2: Creating Custom Middleware

#### Scenario

The server needs to handle the client’s request. You have been asked to find which ball game was chosen by the user. To do this, you will create a middleware.

The main tasks for this exercise are the following: 

1. Create a middleware

2. Run the application

3. Change the order of the middleware

####	Task 1: Create a middleware

1. In the **Startup** class, at the beginning of the **Configure** method, call the **Use** method of the *app* parameter. Pass an async lambda expression as a parameter with the following information:

    - Expression: **async (context, next) => { }**

2. In the **Use** method, in the async lambda expression, add an **IF** statement that checks if the **context.Request.Query.ContainsKey** method returns **TRUE**. To the **ContainsKey** method, pass *"favorite"* as a parameter. 

3. Inside the **IF** statement, add a **string** type, *selectedValue* variable with the value, **context.Request.Query["favorite"]**.

4. Call the **context.Response.WriteAsync** method by using the **await** operator. To the **WriteAsync** method, pass *"Selected value is: " + selectedValue* as a parameter.

5. After the **IF** statement, add an **ELSE** statement.

6. In the **ELSE** statement, call the **Invoke** method of the *next* parameter by using the **await** operator.

####	Task 2: Run the application

1. Save all the changes.

2. Start the application without debugging.

3. Access the following relative path:
    - Path: **/poll-questions.html**

4. Select **Basketball**, and then click **Submit Poll**.
    >**Note**: The browser displays the following text **Selected value is: Basketball**.

5. Close Microsoft Edge.

####	Task 3: Change the order of middleware

1. In the **Startup** class, in the **Configure** method, move the **app.UseStaticFiles** method call to the beginning of the middleware pipeline.

2. Save all the changes.

3. Start the application without debugging.

4. Access the following relative path:
    - Path: **/poll-questions.html**

5. Select **Basketball**, and then click **Submit Poll**.
    >**Note**: The browser displays the **poll-questions.html** file content located under the **wwwroot** folder because the request was captured by the **UseStaticFiles** middleware without executing the **app.Use** middleware.

6. Close Microsoft Edge.

7. Move the **app.UseStaticFiles** method call to be between the **app.Use** middleware and the **app.Run** middleware.

8. In the **app.Use** middleware call, comment out the **ELSE** statement that would run if the *"favorite" query string* parameter does not exist.

9. Save all the changes.

10. Start the application without debugging.

11. Access the following relative path:
    - Path: **/poll-questions.html**
    >**Note**: The browser displays a blank page.

12. Close Microsoft Edge.

13. Uncomment the **ELSE** statement that would run if the *"favorite" query string* parameter does not exist.

>**Result**: At the end of this exercise, you will be able to create a custom middleware and receive submitted form data to it.

### Exercise 3: Using dependency injection

#### Scenario

You will need to aggregate the votes and store them for future use. You will use services to manage and preserve the data.

The main tasks for this exercise are as follows: 

1. Define an interface for a service

2.	Define an implementation for the service

3.	Use dependency injection

4.	Run the application

####	Task 1: Define an interface for a service

1. Create a new top-level folder with the following information:
    - Folder: **Services**

2. Create a new **enum** with the following information:
    - Folder: **Services**
    - Name: **SelectedGame**
    - Values:
        - **Basketball**
        - **Football**
        - **Soccer**
        - **Volleyball**
        - **Billiard**
        - **Hockey**
        - **Golf**
        - **Tennis**

3. Create a new **interface** with the following information:
    - Folder: **Services**
    - Name: **IPollResultsService**
    - Scope: **public**

4. In the **IPollResultsService** interface, declare a method with following information:
    - Return type: **void**
    - Name: **AddVote**
    - Parameter:
        - Name: **game**
        - Type: **SelectedGame**

5. Declare a method with following information:
    - Name: **GetVoteResult**
    - Return type: **SortedDictionary&lt;SelectedGame, int&gt;**

####	Task 2: Define an implementation for the service

1. Create a new class with following information:
    - Scope: **Public**
    - Folder: **Services**
    - Name: **PollResultsService**

2. To implement the **IPollResultsService** interface, modify the **PollResultsService** class.

3. Add a new field with the following information:
    - Scope: **private**
    - Type: **Dictionary&lt;SelectedGame, int&gt;**
    - Name: **_selectionVotes**

4. Add a parameter-less constructor with the following information:
    - Scope: **public**

5. In the constructor, initialize the **_selectionVotes** field by using the **Dictionary&lt;SelectedGame, int&gt;** constructor.

6. Add a method with the following information:
    - Scope: **public**
    - Return Type: **void**
    - Name: **AddVote**
    - Parameter:
        - Type: **SelectedGame**
        - Name: **game**

7. In the **AddVote** method code block, add an **IF** statement that checks that the **_selectionVotes.ContainsKey** method returns **TRUE**. To the **ContainsKey** method, pass *game* as a parameter. 

8. In the **IF** statement code block, increase the **_selectionVotes[game]** value by 1.

9. After the **IF** statement, add an **ELSE** statement.

10.  In the **ELSE** statement code block, call the **Add** method of the **_selectionVotes** field. To the **Add** method, pass *game* and *1* as parameters.

11. Add a method with the following information:
    - Scope: **public**
    - Return Type: **SortedDictionary&lt;SelectedGame, int&gt;**
    - Name: **GetVoteResult**

12. In the **GetVoteResult** method code block, return a new **SortedDictionary&lt;SelectedGame, int&gt;** object by using the **SortedDictionary&lt;SelectedGame, int&gt;** constructor. 

13. To the **SortedDictionary&lt;SelectedGame, int&gt;** constructor, pass the **_selectionVotes** field as a parameter.


####	Task 3: Use dependency injection

1. In the **Startup** class, add the **USING** statements for the **PollBall.Services** namespace. 

2. In the **ConfigureServices** method, call the **AddSingleton** method of services parameters with the following information: 
    - Interface: **IPollResultsService**
    - Implementation: **PollResultsService**

3. Change the **Configure** method signature to accept the following parameters:
    - Parameter:
        - Type: **IApplicationBuilder**
        - Name: **app**
    - Parameter:
        - Type: **IHostingEnvironment**
        - Name: **env**
    - Parameter:
        - Type: **IPollResultsService**
        - Name: **pollResults**

4. In the **Configure** method, in the **app.Run** lambda expression code block, replace the string parameter passed to the **WriteAsync** method with the following information:

    - Parameter: **"This text was generated by the app.Run middleware. wwwroot folder path: " + env.WebRootPath**.

5. In the **app.Use** lambda expression code block, delete the call to **context.Response.WriteAsync**.

6. Inside the **IF** statement, add a variable named **selectedGame** of the**SelectedGame** type with the value, **(SelectedGame)Enum.Parse(typeof(SelectedGame), selectedValue, true)**.

7. Call the **AddVote** method of the *pollResults* parameter. To the **AddVote** method, pass the *selectedGame* variable as a parameter.

8. Add a *gameVotes* variable of the **SortedDictionary&lt;SelectedGame, int&gt;** type.  Initialize the *gameVotes* variable with the result of the **pollResults.GetVoteResult** method call.

9. Create a **FOREACH** statement block with the following information:

    - Variable Type: **KeyValuePair&lt;SelectedGame, int&gt;**
    - Variable Name: **currentVote**
    - Collection: **gameVotes**

10.  In the **FOREACH** statement block, call the **context.Response.WriteAsync** method by using the **await** operator. To the **WriteAsync** method, pass *"&lt;div&gt; Game name: {currentVote.Key}. Votes: {currentVote.Value} 	&lt;/div&gt;"* as a parameter. 


####	Task 4: Run the application

1. Save all the changes.

2. Start the application without debugging.
    >**Note**: The browser displays the following text **This text was generated by the app.Run middleware. wwwroot folder path: [local path to your wwwroot folder]**.

3. Access the following relative path:
    - Path: **/poll-questions.html**

4. Select **Basketball**, and then click **Submit Poll**.
    >**Note**: The browser displays the following text:<br>
	**Game name: Basketball. Votes: 1**

5. Access the following relative path:
    - Path: **/poll-questions.html**

6. Select **Football**, and then click **Submit Poll**.
    >**Note**: The browser displays the following text:<br>
**Game name: Basketball. Votes: 1**<br>
**Game name: Football. Votes: 1**

7. Access the following relative path:
    - Path: **/poll-questions.html**

8. Select **Basketball**, and then click **Submit Poll**.
    >**Note**: The browser displays the following text:<br>
**Game name: Basketball. Votes: 2**<br>
**Game name: Football. Votes: 1**

9. Close Microsoft Edge.

 >**Result**:  At the end of this exercise, you will be able to register a service in the **ConfigureServices** method and use the service in the **Configure** method by using dependency injection.

### Exercise 4: Injecting a Service to a Controller

#### Scenario

In this exercise, you will create an ASP.NET Core MVC controller to display the poll results. 

The main tasks for this exercise are the following: 

1.	Enable working with MVC

2.	Add a controller

3.	Run the application

4.	Use dependency injection in a controller

5.	Run the application


####	Task 1: Enable working with MVC

1. In the **ConfigureServices** method, call the **AddMVC** method of the *services* parameter.

2. In **Startup** class, in the **Configure** method, between the **app.UseStaticFiles** and the **app.Run** middleware, call the **UseMvcWithDefaultRoute** method of the *app* parameter.

####	Task 2: Add a controller

1. In the **PollBall** project, create a new top-level folder and name it **Controllers**.

2. Create a new controller with the following information:
    - Controller name: **HomeController**
    - Template: **MVC Controller - Empty**
    - Folder: **Controllers**

3. In the **Index** action, return the **ContentResult** result by using the **Content** method. To the **Content** method, pass *"Hello from controller."* as a parameter.

####	Task 3: Run the application

1. Save all the changes.

2. Start the application without debugging.
    >**Note**: The browser displays the following text: "Hello from controller."

3. Close Microsoft Edge.

4. In the **Startup** class, cut the **app.Run** middleware.

5. Paste the **app.Run** middleware, at the beginning of the **Configure** method code block.

6. Save all the changes.

7. Start the application without debugging.
    >**Note**: The browser displays **This text was generated by the app.Run middleware. wwwroot folder path:" [local path to your wwwroot folder].**<br />

8. Close Microsoft Edge.

9. Move the **app.Run** middleware to the last place in the pipeline.

####	Task 4: Use dependency injection in a controller

1. In the **Startup** class, in the **Configure** method, remove the *gameVotes* variable and the **FOREACH** statement with its content.

2. Call the **context.Response.Header.Add** method. To the **Add** method, pass *"Content-Type"* and *"text/html"* as parameters.

3. Call the **context.Response.WriteAsync** method by using the **await** operator. To the **WriteAsync** method, pass *"Thank you for submitting the poll. You may look at the poll results &lt;a href='/?submitted=true'&gt;Here&lt;/a&gt;."* as a parameter.

4. In the **HomeController** class, add the **USING** statements for the **PollBall.Services** and **System.Text** namespaces.

5. Add a new field with the following information:
    - Type: **IPollResultsService**
    - Name: **_pollResults**
    - Scope: **private**

6. Add a constructor with the following information:
    - Type: **IPollResultsService**
    - Name: **pollResults**

7. In the constructor, initialize the **_pollResults** field with the value of the *pollResults* parameter.

8. Remove the content of the **Index** action.


9. In the **Index** action, add an **IF** statement that checks if the **Request.Query.ContainsKey** method returns **TRUE**. To the **ContainsKey** method, pass **"submitted"** as a parameter. 

10. Inside the **IF** statement, add a *results* variable of the **StringBuilder** type.

11. Initialize the *results* variable by using the **StringBuilder** constructor.

12. Add a *voteList* variable of the **SortedDictionary&lt;SelectedGame, int&gt;** type.

13. Initialize the *voteList* variable with the result of **_pollResults.GetVoteResult** method call.

14. Create a **FOREACH** statement block with the following information:

    - Variable Type: **var**
    - Variable Name: **gameVotes**
    - Collection: **voteList**

15. In the **FOREACH** statement block, call the **Append** method of the *results* variable. To the **Append** method, pass *$"Game name: {gameVotes.Key}. Votes: {gameVotes.Value}{Environment.NewLine}"* as a parameter. 

16. After the **FOREACH** statement block, return the **ContentResult** result by using the **Content** method. To the **Content** method, pass the *results.ToString()* string as a parameter.

17. After the **IF** statement, add an **ELSE** statement.

18. Inside the **ELSE** statement, return the **RedirectResult** result by using the **Redirect** method. To the **Redirect** method, pass *"poll-questions.html"* as a parameter.

####	Task 5: Run the application

1. Save all the changes.

2. Start the application without debugging.
    >**Note**: The browser displays the **http://localhost:[port]/poll-questions.html** page.

3. Select **Basketball**, and then click **Submit Poll**.
    > **Note**: The browser displays **Thank you for submitting the poll. You may look at the poll results Here.**

4. Click **Here**.
    >**Note**: The browser displays the following text:<br>
**Game name: Basketball. Votes: 1**

5. Open a new Microsoft Edge window.

6. Access the following relative path:
    - Path: **/poll-questions.html**

7. Select **Football**, and then click **Submit Poll**.
    >**Note**: The browser displays the following text:<br>
**Thank you for submitting the poll. You may look at the poll results Here**.

8. Click **Here**.
    >**Note**: The browser displays the following text:<br>
**Game name: Basketball. Votes: 1** <br> 
**Game name: Football. Votes: 1**

9. Close all the Microsoft Edge windows.

10. Close Microsoft Visual Studio.

>**Result**: At the end of this exercise, you will be able to create a controller, and inject a service into it with dependency injection. 

©2018 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode), additional terms may apply. All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant. This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided &quot;as-is.&quot; Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.
