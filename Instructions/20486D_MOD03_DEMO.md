# Module 3: Configuring Middleware and Services in ASP.NET Core

Wherever a path to a file starts with *[Repository Root]*, replace it with the absolute path to the folder in which the 20486 repository resides. For example, if you cloned or extracted the 20486 repository to **C:\Users\John Doe\Downloads\20486**, change the path: **[Repository Root]\AllFiles\20486D\Mod01** to **C:\Users\John Doe\Downloads\20486\AllFiles\20486D\Mod01**.

# Lesson 1: Configuring Middleware

### Demonstration: How to Create Custom Middleware

#### Preparation Steps 

Ensure that you have cloned the **20486D** directory from GitHub. It contains the code segments for the labs and demos of this course. (**https://github.com/MicrosoftLearning/20486D-DevelopingASPNETMVCWebApplications/tree/master/Allfiles**).


#### Demonstration Steps

1. Start Visual Studio 2017.

2. In the **Start Page - Microsoft Visual Studio** window, on the **FILE** menu, point to **New**, and then click **Project**.

3. In the **New Project** dialog box, in the navigation pane, expand **Installed**, and then click **Visual C#**.

4. In the **New Project** dialog box, in the result pane, click **ASP.NET Core Web Application**.

5. In the **Name** box, type **ConfigureMiddlewareExample**.

6. In the **Location** box, write **[Repository Root]\Allfiles\Mod03\Democode\01_ConfigureMiddlewareExample_begin**, and then click **OK**. 

7. In the **New ASP.NET Core Web Application - ConfigureMiddlewareExample** dialog box, in the result pane, click **Empty**, ensure that the check boxes are cleared, and then click **OK**.

8. In the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.

9. In Microsoft Edge, in the address bar, note the port number that appears at the end of the URL **http://localhost:[port]**. You will use the port number during this demonstration.

10. In Microsoft Edge, click **Close**.

11. In the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, in **Solution Explorer**, click **Startup.cs**.

12. In the **Startup.cs** code window, delete any existing comment in the file.

13. In the **Startup.cs** code window, delete the **Configure** method with its content.

14. In the **Startup.cs** code window, place the cursor below the **ConfigureServices** method, and then type the following code:
```cs
    public void Configure(IApplicationBuilder app)
    {
        app.Run(async (context) =>
        {
            await context.Response.WriteAsync("This text was generated by the app.Run middleware.");
        });
    }
```

15. In the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

16. In the **ConfigureMiddlewareExample – Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**. 

17. In Microsoft Edge, in the address bar, type **http://localhost:[port]/UrlTest1**, and then press Enter.
    >**Note**: The browser displays: **This text was generated by the app.Run middleware.**

18. In Microsoft Edge, in the address bar, type **http://localhost:[port]/UrlTest2**, and then press Enter.
    >**Note**: The browser displays: **This text was generated by the app.Run middleware.**

19. In Microsoft Edge, click **Close**.

20. In the **Startup.cs** code window, locate the following code:
```cs
    public void Configure(IApplicationBuilder app)
    {
```

21. Place the cursor after the **{** (opening braces) sign, press Enter, type the following code, and then press Enter.
```cs
    app.Use(async (context, next) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.Use middleware. Request path is: " + context.Request.Path.Value + "<br />");
    });
```

22. In the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

23. In the **ConfigureMiddlewareExample – Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.

24. In Microsoft Edge, in the address bar, type **http://localhost:[port]/UrlTest1**, and then press Enter.
    >**Note**: The browser displays: **This text was generated by the app.Use middleware. Request path is: /UrlTest1**.

25. In Microsoft Edge, in the address bar, type **http://localhost:[port]/UrlTest2**, and then press Enter.
    >**Note**: The browser displays: **This text was generated by the app.Use middleware. Request path is: /UrlTest2**.

26. In Microsoft Edge, click **Close**.

27. In the **Startup.cs** code window, locate the following code:
```cs
    await context.Response.WriteAsync("This text was generated by the app.Use middleware. Request path is: " + context.Request.Path.Value + "<br />");
```

28. Place the cursor at the end of the located code, press Enter, and then type the following code:
```cs
    await next.Invoke();
```

29. In the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

30. In the **ConfigureMiddlewareExample – Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.
    >**Note**: The browser displays: <br />
						 **This text was generated by the app.Use middleware. Request path is: /  <br />
This text was generated by the app.Run middleware.**

31. In Microsoft Edge, click **Close**.

32. In the **Startup.cs** code window, select the following code:
```cs
    app.Use(async (context, next) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.Use middleware. Request path is: " + context.Request.Path.Value + "<br />");
        await next.Invoke();
    });
```

33. Right-click the selected code, and then click **Cut**.

34. In the **Startup.cs** code window, locate the following code:
```cs
    app.Run(async (context) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.Run middleware.");
    });
```

35. Place the cursor at the end of the located code, press Enter twice, right-click at the cursor location, and then click **Paste**.

36. In the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

37. In the **ConfigureMiddlewareExample – Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.
    >**Note**: The browser displays: **This text was generated by the app.Run middleware.**

38. In Microsoft Edge, click **Close**.

39. In the **Startup.cs** code window, select the following code:
```cs
    app.Run(async (context) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.Run middleware.");
    });
```

40. Right-click the selected code, and then click **Cut**.

41. In the **Startup.cs** code window, locate the following code:
```cs
    app.Use(async (context, next) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.Use middleware. Request path is: " + context.Request.Path.Value + "<br />");
        await next.Invoke();
    });
```

42. Place the cursor at the end of the located code, press Enter twice, right-click at the cursor location, and then click **Paste**.

43. In the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

44. In the **ConfigureMiddlewareExample - Microsoft Visual Studio** window, on the **FILE** menu, click **Exit**.

# Lesson 1: Configuring Middleware

### Demonstration: How to Work with Static Files

#### Preparation Steps 

Ensure that you have cloned the **20486D** directory from GitHub. It contains the code segments for the labs and demos in this course. (**https://github.com/MicrosoftLearning/20486D-DevelopingASPNETMVCWebApplications/tree/master/Allfiles**).


#### Demonstration Steps

1. Start Visual Studio 2017.

2. In the **Start Page - Microsoft Visual Studio** window, on the **FILE** menu, point to **New**, and then click **Project**.

3. In the **New Project** dialog box, in the navigation pane, expand **Installed**, and then click **Visual C#**.

4. In the **New Project** dialog box, in the result pane, click **ASP.NET Core Web Application**.

5. In the **Name** box, type **StaticFilesExample**.

6. In the **Location** box, type **[Repository Root]\Allfiles\Mod03\Democode\02_StaticFilesExample_begin**, and then click **OK**. 

7. In the **New ASP.NET Core Web Application - StaticFilesExample** dialog box, in the result pane, click **Empty**, ensure that the check boxes are cleared, and then click **OK**.
    >**Note**: In **Solution Explorer** of the **StaticFilesExample - Microsoft Visual Studio** window, notice that the **wwwroot** folder is empty.

8. In the **File Explorer** window, go to **[Repository Root]\Allfiles\Mod03\Democode\02_StaticFilesExample_begin**.

9. In the **02_StaticFilesExample_begin** window, select the **html-file.html** and the **image-file.jpg** files.
 
10. Right-click the selected files, and then click **Copy**.

11. In the **File Explorer** window, go to **[Repository Root]\Allfiles\Mod03\Democode\02_StaticFilesExample_begin\StaticFilesExample\StaticFilesExample\wwwroot**.

12. In the **wwwroot** window, right-click an empty space, and then click **Paste**.
    >**Note**: In the **StaticFilesExample - Microsoft Visual Studio** window, in **Solution Explorer**, ensure that the **wwwroot** folder contains the copied files (You might need to expand the wwwroot directory to see the files).
    
13. In the **StaticFilesExample - Microsoft Visual Studio** window, in **Solution Explorer**, click **Startup.cs**.

14. In the **Startup.cs** code window, delete any existing comment in the file.

15. In the **Startup.cs** code window, delete the **Configure** method with its content.

16. In the **Startup.cs** code window, place the cursor below the **ConfigureServices** method, and then type the following code:
```cs
    public void Configure(IApplicationBuilder app)
    {
        app.Run(async (context) =>
        {
            await context.Response.WriteAsync("This text was generated by the app.Run middleware.");
        });
    }
```
17. In the **StaticFilesExample - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

18. In the **StaticFilesExample – Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.

19. In Microsoft Edge, in the address bar, type **http://localhost:[port]/html-file.html**, and then press Enter.
    >**Note**: The browser displays **This text was generated by the app.Run middleware.**

20. In Microsoft Edge, in the address bar, type **http://localhost:[port]/image-file.jpg**, and then press Enter.
    >**Note**: The browser displays **This text was generated by the app.Run middleware.**

21. In Microsoft Edge, in the address bar, type **http://localhost:[port]/nonexisting-path.jpg**, and then press Enter.
    >**Note**: The browser displays **This text was generated by the app.Run middleware.**

22. In Microsoft Edge, click **Close**.

23. In **Solution Explorer**, click **Startup.cs**.

24. In the **Startup.cs** code window, locate the following code:
```cs
    public void Configure(IApplicationBuilder app)
    {
```

25. Place the cursor after the **{** (opening braces) sign, press Enter, and then type the following code:
```cs
    app.UseStaticFiles();
```
26. In the **StaticFilesExample - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

27. In the **StaticFilesExample – Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.

28. In Microsoft Edge, in the address bar, type **http://localhost:[port]/html-file.html**, and then press Enter.
    >**Note**: The browser displays the HTML file content: **Hello From HTML File !**

29. In Microsoft Edge, in the address bar, type **http://localhost:[port]/image-file.jpg**, and then press Enter.
    >**Note**: The browser displays the image file.

30. In Microsoft Edge, in the address bar, type **http://localhost:[port]/nonexisting-path.jpg**, and then press Enter.
    >**Note**: The browser displays **This text was generated by the app.Run middleware**.

31. In Microsoft Edge, click **Close**.

32. In the **StaticFilesExample - Microsoft Visual Studio** window, on the **FILE** menu, click **Exit**.

# Lesson 2: Configuring Services

### Demonstration: How to Use Dependency Injection

#### Preparation Steps 

Ensure that you have cloned the **20486D** directory from GitHub. It contains the code segments for the labs and demos in this course. (**https://github.com/MicrosoftLearning/20486D-DevelopingASPNETMVCWebApplications/tree/master/Allfiles**).


#### Demonstration Steps

1. Start Visual Studio 2017.

2. In the **Start Page - Microsoft Visual Studio** window, on the **FILE** menu, point to **New**, and then click **Project**.

3. In the **New Project** dialog box, in the navigation pane, expand **Installed**, and then click **Visual C#**.

4. In the **New Project** dialog box, in the result pane, click **ASP.NET Core Web Application**.

5. In the **Name** box, type **ConfigureServiceExample**.

6. In the **Location** box, write **[Repository Root]\Allfiles\Mod03\Democode\03_ConfigureServiceExample_begin**, and then click **OK**. 

7. In the **New ASP.NET Core Web Application - ConfigureServiceExample** dialog box, in the result pane, click **Empty**, ensure that the check boxes are cleared, and then click **OK**.

8. In the **ConfigureServiceExample - Microsoft Visual Studio** window, in **Solution Explorer**, click **Startup.cs**.

9. In the **Startup.cs** code window, delete any existing comment in the file.

10. In the **Startup.cs** code window, delete the **Configure** method with its content.

11. In the **Startup.cs** code window, place the cursor below the **ConfigureServices** method, and then type the following code:
```cs
    public void Configure(IApplicationBuilder app)
    {
        app.Run(async (context) =>
        {
            await context.Response.WriteAsync("This text was generated by the app.Run middleware.");
        });
    }
```

12. In the **ConfigureServiceExample - Microsoft Visual Studio** window, in **Solution Explorer**, right-click **ConfigureServiceExample**, point to **Add**, and then click **New Folder**.

13.	In the **NewFolder** box, type **Services**, and then press Enter.

14. In **Solution Explorer**, right-click **Services**, point to **Add**, and then click **Class**.

15. In the **Add New Item – ConfigureServiceExample** dialog box, in the **Name** box, type **Logger**, and then click **Add**.

16. In the **Logger.cs** code window, locate the following code:
```cs
    using System.Threading.Tasks;
```

17. Place the cursor at the end of the located code, press Enter, and then type the following code:
```cs
    using System.IO;
```

18. In the **Logger.cs** code window, locate the following code:
```cs
    public class Logger
    {
```

19. Place the cursor at the end of the located code, press Enter, and then type the following code:
```cs
    string _fileName;
```

20. Place the cursor at the end of the **_fileName** field, press Enter twice, and then type the following code:
```cs
    public Logger()
    {
    }
```

21. Place the cursor within the **Logger** constructor code block, press Enter, and then type the following code:
```cs
    _fileName = $"{DateTime.UtcNow.ToString("yyyy-dd-MM--HH-mm-ss")}.log";
```

22. Place the cursor at the end of the **Logger** constructor, press Enter twice, and then type the following code:
```cs
    public void Log(string logData)
    {
        File.AppendAllText(_fileName, $"{DateTime.UtcNow}: {logData}");
    }
```

23. In the **ConfigureServiceExample - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

24. In the **Logger.cs** code window, locate the following code:
```cs
    public class Logger
```

25. Right-click the **Logger** class name, click **Quick Actions and Refactorings...**, and then click **Extract Interface...**.

26. In the **Extract Interface** dialog window, click **OK**.

27. In the **ConfigureServiceExample - Microsoft Visual Studio** window, in **Solution Explorer**, click **Startup.cs**.

28. In the **Startup.cs** code window, locate the following code:
```cs
    using Microsoft.Extensions.DependencyInjection;
```

29. Place the cursor at the end of the located code, press Enter, and then type the following code:
```cs
    using ConfigureServiceExample.Services;
```

30. Place the cursor within the **ConfigureServices** method block, press Enter, and then type the following code:
```cs
    services.AddSingleton<ILogger, Logger>();
```

31. In the **Startup.cs** code window, select the following code:
```cs
    public void Configure(IApplicationBuilder app)
```

32. Replace the selected code with the following code:
```cs
    public void Configure(IApplicationBuilder app, ILogger logger)
```

33. In the **Configure** method, locate the following code:
```cs
    app.Run(async (context) =>
    {
```

34. Place the cursor after the **{** (opening braces) sign, press Enter, and then type the following code:
```cs
    logger.Log("Logged line");
```
35. In the **ConfigureServiceExample- Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

36. In the **ConfigureServiceExample – Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.
    >**Note**: The browser displays: **This text was generated by the app.Run middleware.** <br/>
    In **Solution Explorer**, in the project main directory, verify that a log file was created. 

37. In Microsoft Edge, click **Close**.

38. In **Solution Explorer**, double click the newly created **XXXX-XX-XX--XX-XX-XX.log** file.
    >**Note**: The text inside the log file is: *[DateTime]***: Logged line**.

39. In the **ConfigureServiceExample - Microsoft Visual Studio** window, on the **FILE** menu, click **Exit**.

©2018 Microsoft Corporation. All rights reserved.

The text in this document is available under the  [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode), additional terms may apply. All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are  **not** included within the Creative Commons license grant. This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided &quot;as-is.&quot; Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.