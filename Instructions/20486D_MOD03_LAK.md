# Module 3: Configuring Middleware and Services in ASP.NET Core

Wherever a path to a file starts with *[Repository Root]*, replace it with the absolute path to the folder in which the 20486 repository resides. For example, if you cloned or extracted the 20486 repository to **C:\Users\John Doe\Downloads\20486**, change the path: **[Repository Root]\AllFiles\20486D\Mod01** to **C:\Users\John Doe\Downloads\20486\AllFiles\20486D\Mod01**.

# Lab: Configuring Middleware and Services in ASP.NET Core 

### Lab Setup

Estimated Time: **75 minutes**

### Preparation Steps

Ensure that you have cloned the 20486D directory from GitHub. It contains the code segments for the labs and demos in this course. (**https://github.com/MicrosoftLearning/20486D-DevelopingASPNETMVCWebApplications/tree/master/Allfiles**).

###	Exercise 1: Working with Static Files

#### Task 1: Create a new project by using the ASP.NET Core Empty project template

1. Start Microsoft Visual Studio 2017.

2. In the **Start Page - Microsoft Visual Studio** window, on the **FILE** menu, point to **New**, and then click **Project**.

3. In the **New Project** dialog box, in the navigation pane, expand **Installed**, and then click **Visual C#**.

4. In the **New Project** dialog box, in the result pane, click **ASP.NET Core Web Application**.

5. In the **Name** box, enter **PollBall**.

6. In the **Location** box, enter **[Repository Root]Allfiles\Mod03\Labfiles\01_PollBall_begin**, and then click **OK**.

7. In the **New ASP.NET Core Web Application - PollBall** dialog box, in the result pane, click **Empty**. Ensure that the check boxes are cleared, and then click **OK**.

8. In the **PollBall - Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.

9. In Microsoft Edge, in the address bar, note the port number that appears at the end of the URL **http://localhost:[port]**. You will use the port number during this lab.

10. In Microsoft Edge, click **Close**.

11. In the **PollBall - Microsoft Visual Studio** window, in Solution Explorer, click **Startup.cs**.

12. In the **Startup.cs** code window, delete any existing comment in the file.

13. In the **Startup.cs** code window, delete the **Configure** method with its content.

14. In the **Startup.cs** code window, place the cursor below the **ConfigureServices** method, and then enter the following code:
```cs
    public void Configure(IApplicationBuilder app)
    {
        app.Run(async (context) =>
        {
             await context.Response.WriteAsync("This text was generated by the app.Run middleware.");
        });
    }
```

#### Task 2: Run the application

1. In the **PollBall - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

2. In the **PollBall –  Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.
> **Note**: The browser displays **This text was generated by the app.Run middleware.**

3. In Microsoft Edge, click **Close**.

#### Task 3: Add an HTML file to the wwwroot folder

1. In the **PollBall - Microsoft Visual Studio** window, in Solution Explorer, right-click **wwwroot**, point to **Add**, and then click **New Folder**.

2.	In the **NewFolder** box, enter **css**, and then press Enter.

3. In File Explorer, go to **[Repository Root]Allfiles\Mod03\Labfiles\01_PollBall_begin**.

4.	In the **01_PollBall_begin** window, right-click **style.css**, and then click **Copy**.

5.	In File Explorer, browse to **[Repository Root]Allfiles\Mod03\Labfiles\01_PollBall_begin\PollBall\PollBall\wwwroot\css**.

6. In File Explorer, right-click an empty space, and then click **Paste**.
    > **Note**: Verify that in Solution Explorer, under **wwwroot**,  under **css**, the **style.css** file is displayed.

7. In File Explorer, browse to **[Repository Root]Allfiles\Mod03\Labfiles\01_PollBall_begin**.

8.	In the **01_PollBall_begin** window, right-click **images**, and then click **Copy**.

9.	In File Explorer, browse to **[Repository Root]Allfiles\Mod03\Labfiles\01_PollBall_begin\PollBall\PollBall\wwwroot**.

10.	In File Explorer, right-click an empty space, and then click **Paste**.
    > **Note**: Verify that in Solution Explorer, under **wwwroot**,  the **images** folder is displayed.

11. In the **PollBall - Microsoft Visual Studio** window, in Solution Explorer, right-click **wwwroot**, point to **Add**, and then click **New Item**.

12.	In the **Add New Item – PollBall** dialog box, expand **Installed**, click **ASP.NET Core**, and then click **HTML Page**.

13. In the **Add New Item – PollBall** dialog box, In the **Name** box, enter **poll-questions**, and then click **Add**.

14. In the **poll-questions.html** code window, in the **BODY** element,  enter the following code, and then press Enter.
```cs
    <p>
        <h1>Favorite Ball Game Poll</h1>
        Please select your favorite ball game, and then press Submit Poll.
    </p>
```

15. In the **BODY** element, below the **P** element, 	enter the following code:
```cs
    <form class="submit-form">
        <div class="main-div">

        </div>
        <div class="submit-batch">
            <input type="submit" value="Submit Poll" />
        </div>
    </form>
```

16. In the **DIV** element, in the **main-div** class attribute, enter the following code, and then press Enter.
```cs
    <div class="main-batch1">
        <div class="item">
            <div class="img-item"><img src="images\basketball.png" /></div>
            <div class="input-item"><input type="radio" name="favorite" value="Basketball"> Basketball</div>
        </div>
        <div class="item">
            <div class="img-item"><img src="images\football.png" /></div>
            <div class="input-item"><input type="radio" name="favorite" value="Football"> Football</div>
        </div>
        <div class="item">
            <div class="img-item"><img src="images\soccer.png" /></div>
            <div class="input-item"><input type="radio" name="favorite" value="Soccer"> Soccer</div>
        </div>
        <div class="item">
            <div class="img-item"><img src="images\volleyball.png" /></div>
            <div class="input-item"><input type="radio" name="favorite" value="Volleyball"> Volleyball</div>
        </div>
    </div>
```

17. In the **DIV** element, in the **main-div** class attribute, under the code you just added, enter the following code:
```cs
    <div class="main-batch2">
        <div class="item">
            <div class="img-item"><img src="images\billiard.png" /></div>
            <div class="input-item"><input type="radio" name="favorite" value="Billiard"> Billiard</div>
        </div>
        <div class="item">
            <div class="img-item"><img src="images\golf.png" /></div>
            <div class="input-item"><input type="radio" name="favorite" value="Golf"> Golf</div>
        </div>
        <div class="item">
            <div class="img-item"><img src="images\hockey.png" /></div>
            <div class="input-item"><input type="radio" name="favorite" value="Hockey"> Hockey</div>
        </div>
        <div class="item">
            <div class="img-item"><img src="images\tennis.png" /></div>
            <div class="input-item"><input type="radio" name="favorite" value="Tennis"> Tennis</div>
        </div>
    </div>
```

#### Task 4: Run the application – content of the HTML file is not displayed

1. In the **PollBall - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

2. In the **PollBall –  Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.

3. In Microsoft Edge, in the address bar, enter **http://localhost:[port]/poll-questions.html**, and then press Enter.
    > **Note**: The browser displays **This text was generated by the app.Run middleware.** and not the content of the **poll-questions.html** file.

4. In Microsoft Edge, click **Close**.
 
#### Task 5: Enable working with static files

1. In the **PollBall - Microsoft Visual Studio** window, in Solution Explorer, click **Startup.cs**.

2. In the **Startup.cs** code window, locate the following code:
```cs
    public void Configure(IApplicationBuilder app)
    {
```

3. Place the cursor after the **{** (opening braces) sign, press Enter, enter the following code, and then press Enter.
```cs
    app.UseStaticFiles();
```

#### Task 6: Run the application – content of the HTML file is displayed

1. In the **PollBall - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

2. In the **PollBall - Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.

3. In Microsoft Edge, in the address bar, enter **http://localhost:[port]/poll-questions.html**, and then press Enter.
    >**Note**: The browser displays the **poll-questions.html** file content, but the HTML content is not designed by a CSS file yet.

4. In Microsoft Edge, click **Close**.

5. In Solution Explorer, under **wwwroot**, click **poll-questions.html**.

6. In the **poll-questions.html** code window, in the **HEAD** element, below the **TITLE** element,  enter the following code:
```cs
    <link type="text/css" rel="stylesheet" href="css/style.css" />
```

7. In the **PollBall - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

8. In the **PollBall –  Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.

9. In Microsoft Edge, in the address bar, enter **http://localhost:[port]/poll-questions.html**, and then press Enter.
     > **Note**: The browser displays the **poll-questions.html** file content that is designed by using the **style.css** file.

10. In Microsoft Edge, click **Close**.

#### Task 7: Add an HTML file outside the wwwroot folder

1. In File Explorer, browse to **[Repository Root]Allfiles\Mod03\Labfiles\01_PollBall_begin**, right-click **test.html**, and then click **Copy**. 

2. In File Explorer, browse to **[Repository Root]Allfiles\Mod03\Labfiles\01_PollBall_begin\PollBall\PollBall**, right-click an empty space, and then click **Paste**.

#### Task 8: Run the application – content of the HTML file outside the wwwroot folder is not displayed

1. In the **PollBall –  Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.

2. In Microsoft Edge, in the address bar, enter **http://localhost:[port]/test.html**, and then press Enter.
     >**Note**: The browser displays **This text was generated by the app.Run middleware.** By default, the browser cannot display static files that are outside the **wwwroot** directory.

3. In Microsoft Edge, click **Close**.

>**Result**: At the end of this exercise, you will be able to work with static files inside a Microsoft ASP.NET Core project.

###	Exercise 2: Creating Custom Middleware

#### Task 1: Create a middleware

1. In the  **PollBall – Microsoft Visual Studio**  window, in Solution Explorer, click  **Startup.cs**.

2. In the **Startup.cs** code window, locate the following code:
```cs
    public void Configure(IApplicationBuilder app)
    {
```

3. Place the cursor after the **{** (opening braces) sign, press Enter, enter the following code, and then press Enter.
```cs
    app.Use(async (context, next) =>
    {
    
    });
```

4. Place the cursor within the **app.Use** code block, and then enter the following code:
```cs
    if (context.Request.Query.ContainsKey("favorite"))
    {
    
    }
``` 

5. In the **if** statement code block, enter the following code, and then press Enter twice.
```cs
    string selectedValue = context.Request.Query["favorite"];
```

6. In the **if** statement code block,  under the last statement you entered, enter the following code:
```cs
    await context.Response.WriteAsync("Selected value is: " + selectedValue);
```
7. In the **app.Use** code block, place the cursor after the **}** (closing braces) sign of the **if** statement, press Enter, and then enter the following code:
```cs
    else 
    {
        await next.Invoke();
    }
```
#### Task 2: Run the application

1. In the **PollBall - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

2. In the **PollBall - Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.

3. In Microsoft Edge, in the address bar, enter **http://localhost:[port]/poll-questions.html**, and then press Enter.

4. In Microsoft Edge, click **Basketball**, and then click **Submit Poll**.
     >**Note**: The browser displays **Selected value is: Basketball**, which is generated by the **app.Use** middleware.

5. In Microsoft Edge, click **Close**.
 
#### Task 3: Change the order of middleware

1. In the **PollBall –  Microsoft Visual Studio** window, in Solution Explorer, click **Startup.cs**.

2. In the **Startup.cs** code window, select the following code:
```cs
    app.UseStaticFiles();
```

3. Right-click the selected code, and then click **Cut**.

4. In the **Startup.cs** code window, locate the following code:
```cs
    public void Configure(IApplicationBuilder app)
    {
```

5. Place the cursor after the **{** (opening braces) sign, press Enter, right-click at the cursor location, click **Paste**, and then press Enter.

6. In the **PollBall - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

7. In the **PollBall - Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.

8. In Microsoft Edge, in the address bar, enter **http://localhost:[port]/poll-questions.html**, and then press Enter.

9. In Microsoft Edge, click **Basketball**, and then click **Submit Poll**.
     >**Note**: The browser displays the **poll-questions.html** file content located under **wwwroot** folder because the request was captured by the **UseStaticFiles** middleware without executing the **app.Use** middleware.

10. In Microsoft Edge, click **Close**.

11. In the **Startup.cs** code window, select the following code:
```cs
    app.UseStaticFiles();
```

12. Right-click the selected code, and then click **Cut**.

13. In the **Startup.cs** code window, locate the following code:
```cs
    app.Use(async (context, next) =>
    {
        if (context.Request.Query.ContainsKey("favorite"))
        {
            string selectedValue = context.Request.Query["favorite"];
            await context.Response.WriteAsync("Selected value is: " + selectedValue);
        }
        else
        {
            await next.Invoke();
        }
    });
```

14. Place the cursor at the end of the located code, press Enter twice, right-click at the cursor location, and then click **Paste**. 

15. In the **Startup.cs** code window, select the following code:
```cs
    else 
    {
        await next.Invoke();
    }
```

16. Replace the selected code with the following code:
```cs
    //else 
    //{
    //    await next.Invoke();
    //}
```

17. In the **PollBall - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

18. In the **PollBall - Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.

19. In Microsoft Edge, in the address bar, enter **http://localhost:[port]/poll-questions.html**, and then press Enter.

    >**Note**: The browser displays an empty page, Commenting out the **next.Invoke()** method call prevented the invocation of the **UseStaticFiles** method. 

20. In Microsoft Edge, click **Close**.

21. In the **Startup.cs** code window, select the following code:
```cs
    //else 
    //{
    //    await next.Invoke();
    //}
```

22. Replace the selected code with the following code:
```cs
    else 
    {
        await next.Invoke();
    }
```
 
>**Result**: At the end of this exercise, you will be able to create a custom middleware and receive submitted form data to it.

###	Exercise 3: Using Dependency Injection

#### Task 1: Define an interface for a service

1. In the **PollBall - Microsoft Visual Studio** window, in Solution Explorer, right-click **PollBall**, point to **Add**, and then click **New Folder**.

2. In the **NewFolder** box, enter **Services**, and then press Enter.

3. In the **PollBall - Microsoft Visual Studio** window, in Solution Explorer, right-click **Services**, point to **Add**, and then click **Class**.

4. In the **Add New Item - PollBall** dialog box, in the **Name** box, enter **SelectedGame**, and then click **Add**.

5. In the **SelectedGame.cs** code window, select the following code:
```cs
    public class SelectedGame
```

6. Replace the selected code with the following code:
```cs
    public enum SelectedGame
```

7. Place the cursor within the **SelectedGame** enum code block, press Enter, and then enter the following code:
```cs
    Basketball,
    Football,
    Soccer,
    Volleyball,
    Billiard,
    Hockey,
    Golf,
    Tennis
```

8. In the **PollBall - Microsoft Visual Studio** window, in Solution Explorer, right-click **Services**, point to **Add**, and then click **New Item**.

9. In the **Add New Item – PollBall** dialog box, click **Interface**.

10. In the **Add New Item – PollBall** dialog box, in the **Name** box, enter **IPollResultsService**, and then click **Add**.

11. In the **IPollResultsService.cs** code window, select the following code:
```cs
    interface IPollResultsService
```

12. Replace the selected code with the following code:
```cs
    public interface IPollResultsService
```

13. Place the cursor within the **IPollResultsService** interface code block, press Enter, and then enter the following code:
```cs
    void AddVote(SelectedGame game);
    SortedDictionary<SelectedGame, int> GetVoteResult();
``` 

#### Task 2: Define an implementation for the service

1. In the **PollBall - Microsoft Visual Studio** window, in Solution Explorer, right-click **Services**, point to **Add**, and then click **Class**.

2.	In the **Add New Item - PollBall** dialog box, in the **Name** box, enter **PollResultsService**, and then click **Add**.

3. In the **PollResultsService.cs** code window, locate the following code:
```cs
    public class PollResultsService
```

4. Append the following code to the existing line of code:
```cs
     : IPollResultsService
```

5. In the **PollResultsService.cs** code window, locate the following code:
```cs
    public class PollResultsService : IPollResultsService
    {
```

6. Place the cursor at the end of the located code, press Enter, and then enter the following code:
```cs
    private Dictionary<SelectedGame, int> _selectionVotes; 
```

7. Place the cursor at the end of the **_selectionVotes** field, press Enter twice, and then enter the following code:
```cs
    public PollResultsService()
    {
        _selectionVotes = new Dictionary<SelectedGame, int>();
    }
```

8. Place the cursor at the end of the **PollResultsService** constructor, press Enter twice, and then enter the following code:
```cs
    public void AddVote(SelectedGame game)
    {
    
    }
```

9. Place the cursor within the **AddVote** method code block, and then enter the following code:
```cs
    if (_selectionVotes.ContainsKey(game)) 
    {
        _selectionVotes[game]++;
    } 
    else
    {
        _selectionVotes.Add(game, 1);
    }
``` 

10. Place the cursor at the end of the **AddVote** method, press Enter twice, and then enter the following code:
```cs
    public SortedDictionary<SelectedGame, int> GetVoteResult()
    {
    
    }
```

11. Place the cursor within the **GetVoteResult** method code block, and then enter the following code:
```cs
    return new SortedDictionary<SelectedGame, int>(_selectionVotes);
```

#### Task 3: Use dependency injection

1. In the **PollBall - Microsoft Visual Studio** window, in Solution Explorer, click **Startup.cs**.

2. In the **Startup.cs** code window, locate the following code:
```cs
    using Microsoft.Extensions.DependencyInjection;
```

3. Place the cursor at the end of the located code, press Enter, and then enter the following code:
```cs
    using PollBall.Services;
```

4. In the **Startup.cs** code window, locate the following code:
```cs
    public void ConfigureServices(IServiceCollection services)
```

5. Place the cursor within the **ConfigureServices** method code block, press Enter, and then enter the following code:
```cs
    services.AddSingleton<IPollResultsService, PollResultsService>();
```

6. In the **Startup.cs** code window, select the following code:
```cs
    public void Configure(IApplicationBuilder app)
```

7. Replace the selected code with the following code:
```cs
    public void Configure(IApplicationBuilder app, IHostingEnvironment env, IPollResultsService pollResults)
```

8. In the **Startup.cs** code window, select the following code:
```cs
    await context.Response.WriteAsync("This text was generated by the app.Run middleware.");
```

9. Replace the selected code with the following code:
```cs
    await context.Response.WriteAsync("This text was generated by the app.Run middleware. wwwroot folder path: " + env.WebRootPath);
```

10. In the **Startup.cs** code window, locate the following code:
```cs
    string selectedValue = context.Request.Query["favorite"];
```

11. Place the cursor at the end of the located code, press Enter, and then enter the following code:
```cs
    SelectedGame selectedGame = (SelectedGame)Enum.Parse(typeof(SelectedGame), selectedValue, true);
    pollResults.AddVote(selectedGame);
```

12.	In the **Startup.cs** code window, select the following code:
```cs
    await context.Response.WriteAsync("Selected value is: " + selectedValue);
```

13. Replace the selected code with the following code:
```cs
    SortedDictionary<SelectedGame, int> gameVotes = pollResults.GetVoteResult();

    foreach (KeyValuePair<SelectedGame,int> currentVote in gameVotes)
    {
        await context.Response.WriteAsync($"<div> Game name: {currentVote.Key}. Votes: {currentVote.Value} </div>");
    }
```

#### Task 4: Run the application

1. In the **PollBall - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

2. In the **PollBall - Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.
     > **Note**: The browser displays **This text was generated by the app.Run middleware. wwwroot folder path: [local path of your wwwroot folder]**.<br />

3. In Microsoft Edge, in the address bar, enter **http://localhost:[port]/poll-questions.html**, and then press Enter.

4. In Microsoft Edge, click **Basketball**, and then click **Submit Poll**.
     > **Note**: The browser displays:<br /> 
     "Game name: Basketball. Votes: 1"<br />

5. In Microsoft Edge, in the address bar, enter **http://localhost:[port]/poll-questions.html**, and then press Enter.

6. In Microsoft Edge, click **Football**, and then click **Submit Poll**.
    > **Note**: The browser displays:<br />
    >                  **Game name: Basketball. Votes: 1**<br />
    >                   **Game name: Football. Votes: 1**<br />

7. In Microsoft Edge, in the address bar, enter **http://localhost:[port]/poll-questions.html**, and then press Enter.

8. In Microsoft Edge, click **Basketball**, and then click **Submit Poll**.
     > **Note**: The browser displays:<br />
     >                  **Game name: Basketball. Votes: 2**<br />
     >                   **Game name: Football. Votes: 1**<br />

9. In Microsoft Edge, click **Close**.

>**Result**: At the end of this exercise, you will be able to register a service in the **ConfigureServices** method and use the service in the **Configure** method by using dependency injection.


###	Exercise 4: Injecting a Service to a Controller

#### Task 1: Enable working with MVC

1. In the **Startup.cs** code window, locate the following code:
```cs
    services.AddSingleton<IPollResultsService, PollResultsService>();
```

2. Place the cursor at the end of the located code, press Enter, and then enter the following code:
```cs
    services.AddMvc();
```

3. In the **Startup.cs** code window, locate the following code:
```cs
    app.UseStaticFiles();
```

4. Place the cursor at the end of the located code, press Enter twice, and then enter the following code:
```cs
    app.UseMvcWithDefaultRoute();
```

#### Task 2: Add a controller

1. In the **PollBall - Microsoft Visual Studio** window, in Solution Explorer, right-click **PollBall**, point to **Add**, and then click **New Folder**.

2. In the **NewFolder** box, enter **Controllers**, and then press Enter.

3. In the **PollBall - Microsoft Visual Studio** window, in Solution Explorer, right-click **Controllers**, point to **Add**, and then click **Controller**.

4. In the **Add Scaffold** dialog box, select **MVC Controller - Empty**, and then click **Add**.

5. In the **Controller name** box, enter **HomeController**, and then click **Add**.

6. In the **HomeController.cs** code window, select the following code:
```cs
    return View();
```

7. Replace the selected code with the following code:
```cs
    return Content("Hello from controller.");
```

#### Task 3: Run the application

1. In the **PollBall - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

2. In the **PollBall - Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.
     > **Note**: The browser displays **Hello from controller.**

3. In Microsoft Edge, click **Close**.

4. In the **PollBall - Microsoft Visual Studio** window, in Solution Explorer, click **Startup.cs**. 

5. In the **Startup.cs** code window, select the following code:
```cs
    app.Run(async (context) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.Run middleware. wwwroot folder path: " + env.WebRootPath);
    });
```

6. Right-click the selected code, and then click **Cut**.

7. In the **Startup.cs** code window, locate the following code:
```cs
    public void Configure(IApplicationBuilder app, IHostingEnvironment env, IPollResultsService pollResults)
    {
```

8. Place the cursor after the **{** (opening braces) sign, press Enter, right-click at the cursor location, click **Paste**, and then press Enter.

9. In the **PollBall - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

10. In the **PollBall –  Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.
     > **Note**: The browser displays **This text was generated by the app.Run middleware. wwwroot folder path: [local path of your wwwroot folder]**.<br />

11. In Microsoft Edge, click **Close**.

12. In the **Startup.cs** code window, select the following code:
```cs
    app.Run(async (context) =>
    {
        await context.Response.WriteAsync("This text was generated by the app.Run middleware. wwwroot folder path: " + env.WebRootPath);
    });
```

13. Right-click the selected code, and then click **Cut**.

14. In the **Startup.cs** code window, locate the following code:
```cs
    app.UseMvcWithDefaultRoute();
```

15. Place the cursor at the end of the located code, press Enter twice, right-click the cursor location, and then click **Paste**.
 
#### Task 4: Use dependency injection in a controller

1. In the **PollBall - Microsoft Visual Studio** window, in Solution Explorer, click **Startup.cs**. 

2. In the **Startup.cs** code window, select the following code:
```cs
    SortedDictionary<SelectedGame, int> gameVotes = pollResults.GetVoteResult();

    foreach (KeyValuePair<SelectedGame, int> currentVote in gameVotes)
    {
        await context.Response.WriteAsync($"<div> Game name: {currentVote.Key}. Votes: {currentVote.Value} </div>");
    }
```

3. Replace the selected code with the following code:
```cs
	context.Response.Headers.Add("content-type", "text/html");
    await context.Response.WriteAsync("Thank you for submitting the poll. You may look at the poll results <a href='/?submitted=true'>Here</a>.");
```

4. In the **PollBall - Microsoft Visual Studio** window, in Solution Explorer, expand **Controllers**, and then click **HomeController.cs**.

5. In the **HomeController.cs** code window, locate the following code:
```cs
    using Microsoft.AspNetCore.Mvc;
``` 

6. Place the cursor at the end of the located code, press Enter, and then enter the following code:
```cs
    using PollBall.Services;
    using System.Text;
``` 

7. In the **HomeController.cs** code window, locate the following code:
```cs
    public class HomeController : Controller
    {
``` 

8. Place the cursor after the **{** (opening braces) sign, press Enter, and then enter the following code:
```cs
    private IPollResultsService _pollResults;
```

9. Place the cursor at the end of the **_pollResults** field code, press Enter twice, enter the following code, and then press Enter.
```cs
    public HomeController(IPollResultsService pollResults)
    {
        _pollResults = pollResults;
    }
```

10. In the **HomeController.cs** code window, select the following code:
```cs
    return Content("Hello from controller.");
```

11. Replace the selected code with the following code:
```cs
    if (Request.Query.ContainsKey("submitted"))
    {
        StringBuilder results = new StringBuilder();
        SortedDictionary<SelectedGame, int> voteList = _pollResults.GetVoteResult();

        foreach (var gameVotes in voteList)
        {
            results.Append($"Game name: {gameVotes.Key}. Votes: {gameVotes.Value}{Environment.NewLine}");
        }

        return Content(results.ToString());
    }
    else
    {
        return Redirect("poll-questions.html");
    }
```

#### Task 5: Run the application

1. In the **PollBall - Microsoft Visual Studio** window, on the **FILE** menu, click **Save All**.

2. In the **PollBall –  Microsoft Visual Studio** window, on the **DEBUG** menu, click **Start Without Debugging**.
    >**Note**: The browser displays the **http://localhost:[port]/poll-questions.html** page.

4. In Microsoft Edge, click **Basketball**, and then click **Submit Poll**.
     > **Note**: The browser displays **Thank you for submitting the poll. You may look at the poll results Here**.

5. In Microsoft Edge, click **Here**.
     > **Note**: The browser displays:<br />
     >                  **Game name: Basketball. Votes: 1**<br />

6. In Microsoft Edge, open a new window.

7. In the address bar, enter **http://localhost:[port]/poll-questions.html**, and then press Enter.

8. In Microsoft Edge, click **Football**, and then click **Submit Poll**.
    >**Note**: The browser displays **Thank you for submitting the poll. You may look at the poll results Here**.

9.  In Microsoft Edge, click **Here**.
     > **Note**: The browser displays:<br />
     >                  **Game name: Basketball. Votes: 1**<br />
     >                   **Game name: Football. Votes: 1**<br />

10. Close all the Microsoft Edge windows.

11. In the **PollBall - Microsoft Visual Studio** window, on the **FILE** menu, click **Exit**.

>**Result**: At the end of this exercise, you will be able to create a controller, and inject a service into it with dependency injection.

©2018 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode), additional terms may apply. All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant. This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided &quot;as-is.&quot; Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.